<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  Class: Demiurge::Engine
  
    &mdash; Demiurge API Documentation
  
</title>

  <link rel="stylesheet" href="../css/style.css" type="text/css" charset="utf-8" />

  <link rel="stylesheet" href="../css/common.css" type="text/css" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  pathId = "Demiurge::Engine";
  relpath = '../';
</script>


  <script type="text/javascript" charset="utf-8" src="../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="../class_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="../_index.html">Index (E)</a> &raquo;
    <span class='title'><span class='object_link'><a href="../Demiurge.html" title="Demiurge (module)">Demiurge</a></span></span>
     &raquo; 
    <span class="title">Engine</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="../class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><h1>Class: Demiurge::Engine
  
  
  
</h1>
<div class="box_info">
  
  <dl>
    <dt>Inherits:</dt>
    <dd>
      <span class="inheritName">Object</span>
      
        <ul class="fullTree">
          <li>Object</li>
          
            <li class="next">Demiurge::Engine</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
    </dd>
  </dl>
  

  
  
  
  
  <dl>
      <dt>Includes:</dt>
      <dd><span class='object_link'><a href="Util.html" title="Demiurge::Util (module)">Util</a></span></dd>
  </dl>
  
  

  

  
  <dl>
    <dt>Defined in:</dt>
    <dd>lib/demiurge.rb<span class="defines">,<br />
  lib/demiurge/dsl.rb</span>
</dd>
  </dl>
  
</div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    
<p>The Engine class encapsulates one “world” of simulation. This includes
state and code for all items, subscriptions to various events and the
ability to reload state or code at a later point. It is entirely possible
to have multiple Engine objects containing different objects and
subscriptions which are unrelated to each other. If Engines share
references in common, that sharing is ordinarily a bug. Currently only
registered <span class='object_link'><a href="DSL.html" title="Demiurge::DSL (module)">DSL</a></span> Object Types should be shared.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>0.0.1</p>
</div>
      
    </li>
  
</ul>

</div>



  <h2>Instance Attribute Summary <small><a href="#" class="summary_toggle">collapse</a></small></h2>
  <ul class="summary">
    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#execution_context-instance_method" title="#execution_context (instance method)">#<strong>execution_context</strong>  &#x21d2; Hash{String=&gt;String} </a>
    

    
  </span>
  
  
  
    
      <span class="note title readonly">readonly</span>
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>The current execution context for notifications and logging.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#ticks-instance_method" title="#ticks (instance method)">#<strong>ticks</strong>  &#x21d2; Integer </a>
    

    
  </span>
  
  
  
    
      <span class="note title readonly">readonly</span>
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>The number of ticks that have occurred since the beginning of this
Engine&#39;s history.</p>
</div></span>
  
</li>

    
  </ul>




  
    <h2>
      Instance Method Summary
      <small><a href="#" class="summary_toggle">collapse</a></small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#action_for_item-instance_method" title="#action_for_item (instance method)">#<strong>action_for_item</strong>(item_name, action_name)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  <span class="private note title">private</span>

  
    <span class="summary_desc"><div class='inline'>
<p>Fetch an action for an ActionItem that&#39;s stored in the engine.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#actions_for_item-instance_method" title="#actions_for_item (instance method)">#<strong>actions_for_item</strong>(item_name)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  <span class="private note title">private</span>

  
    <span class="summary_desc"><div class='inline'>
<p>Fetch actions for an ActionItem that&#39;s stored in the engine.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#admin_warning-instance_method" title="#admin_warning (instance method)">#<strong>admin_warning</strong>(message, info = {})  &#x21d2; void </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Send a warning that something unfortunate but not continuity-threatening
has occurred.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#advance_one_tick-instance_method" title="#advance_one_tick (instance method)">#<strong>advance_one_tick</strong>  &#x21d2; void </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Perform all necessary operations and phases for one “tick” of virtual time
to pass in the Engine.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#all_actions_for_all_items-instance_method" title="#all_actions_for_all_items (instance method)">#<strong>all_actions_for_all_items</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  <span class="private note title">private</span>

  
    <span class="summary_desc"><div class='inline'>
<p>Fetch all actions for all items in an internal format.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#all_item_names-instance_method" title="#all_item_names (instance method)">#<strong>all_item_names</strong>  &#x21d2; Array&lt;String&gt; </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Get an array of all registered names for all items.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#finished_init-instance_method" title="#finished_init (instance method)">#<strong>finished_init</strong>  &#x21d2; void </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>The “finished_init” callback on Demiurge items exists to allow items to
finalize their structure relative to other items.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#flush_intentions-instance_method" title="#flush_intentions (instance method)">#<strong>flush_intentions</strong>  &#x21d2; void </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Send out all pending <span class='object_link'><a href="Intention.html" title="Demiurge::Intention (class)">Intention</a></span>s in the <span class='object_link'><a href="Intention.html" title="Demiurge::Intention (class)">Intention</a></span>
queue.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#flush_notifications-instance_method" title="#flush_notifications (instance method)">#<strong>flush_notifications</strong>  &#x21d2; void </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Send out any pending notifications that have been queued.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#get_intention_id-instance_method" title="#get_intention_id (instance method)">#<strong>get_intention_id</strong>  &#x21d2; Integer </a>
    

    
  </span>
  
  
  
  
  
  
  <span class="private note title">private</span>

  
    <span class="summary_desc"><div class='inline'>
<p>Get an intention ID which is guaranteed to never be returned by this method
again.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#get_type-instance_method" title="#get_type (instance method)">#<strong>get_type</strong>(t)  &#x21d2; Class </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Get a StateItem type that is registered with this Engine, using the
registered name for that type.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#initialize-instance_method" title="#initialize (instance method)">#<strong>initialize</strong>(types: {}, state: [])  &#x21d2; void </a>
    

    
  </span>
  
  
    <span class="note title constructor">constructor</span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>This is the constructor for a new Engine object.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#instantiate_new_item-instance_method" title="#instantiate_new_item (instance method)">#<strong>instantiate_new_item</strong>(name, parent, extra_state = {})  &#x21d2; Demiurge::StateItem </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>This method creates a new StateItem based on an existing parent StateItem,
and will retain some level of linkage to that parent StateItem afterward as
well.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#item_by_name-instance_method" title="#item_by_name (instance method)">#<strong>item_by_name</strong>(name)  &#x21d2; StateItem<sup>?</sup> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Get a StateItem by its registered unique name.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#load_state_from_dump-instance_method" title="#load_state_from_dump (instance method)">#<strong>load_state_from_dump</strong>(arr)  &#x21d2; void </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>This loads the Engine&#39;s state from structured <span class='object_link'><a href="StateItem.html" title="Demiurge::StateItem (class)">StateItem</a></span>
state that has been serialized.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#next_step_intentions-instance_method" title="#next_step_intentions (instance method)">#<strong>next_step_intentions</strong>  &#x21d2; void </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Calculate the intentions for the next round of the Intention phase of a
tick.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#push_context-instance_method" title="#push_context (instance method)">#<strong>push_context</strong>(context) { ... } &#x21d2; void </a>
    

    
  </span>
  
  
  
  
  
  
  <span class="private note title">private</span>

  
    <span class="summary_desc"><div class='inline'>
<p>Certain context can be important to notifications, errors, logging and
other admin-available information.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#queue_intention-instance_method" title="#queue_intention (instance method)">#<strong>queue_intention</strong>(intention)  &#x21d2; void </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Add an intention to the Engine&#39;s Intention queue.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#queue_item_intentions-instance_method" title="#queue_item_intentions (instance method)">#<strong>queue_item_intentions</strong>  &#x21d2; void </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Queue all Intentions for all registered items for the current tick.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#register_actions_by_item_and_action_name-instance_method" title="#register_actions_by_item_and_action_name (instance method)">#<strong>register_actions_by_item_and_action_name</strong>(item_actions)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>StateItems are transient and can be created, recreated or destroyed without
warning.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#register_state_item-instance_method" title="#register_state_item (instance method)">#<strong>register_state_item</strong>(item)  &#x21d2; Demiurge::StateItem </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Register a new StateItem.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#register_type-instance_method" title="#register_type (instance method)">#<strong>register_type</strong>(name, klass)  &#x21d2; void </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Register a new StateItem type with a name that will be used in structured
<span class='object_link'><a href="StateItem.html" title="Demiurge::StateItem (class)">StateItem</a></span> dumps.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#reload_from_dsl_files-instance_method" title="#reload_from_dsl_files (instance method)">#<strong>reload_from_dsl_files</strong>(*filenames, options: {})  &#x21d2; void </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>This method loads new World File code into an existing engine.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#reload_from_dsl_text-instance_method" title="#reload_from_dsl_text (instance method)">#<strong>reload_from_dsl_text</strong>(*specs, options: { &quot;verify_only&quot; =&gt; false, &quot;guessing_okay&quot; =&gt; false, &quot;no_addition&quot; =&gt; false, &quot;no_removal&quot; =&gt; false })  &#x21d2; void </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>This method loads new World File code into an existing engine.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#replace_all_actions_for_all_items-instance_method" title="#replace_all_actions_for_all_items (instance method)">#<strong>replace_all_actions_for_all_items</strong>(item_action_hash)  &#x21d2; void </a>
    

    
  </span>
  
  
  
  
  
  
  <span class="private note title">private</span>

  
    <span class="summary_desc"><div class='inline'>
<p>Replace actions for an item with other, potentially quite different,
actions.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#send_notification-instance_method" title="#send_notification (instance method)">#<strong>send_notification</strong>(data = {}, type:, zone:, location:, actor:, include_context: false)  &#x21d2; void </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Queue a notification to be sent later by the engine.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#structured_state-instance_method" title="#structured_state (instance method)">#<strong>structured_state</strong>(options = { &quot;copy&quot; =&gt; false })  &#x21d2; Array </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>This method dumps the Engine&#39;s state in <span class='object_link'><a href="StateItem.html" title="Demiurge::StateItem (class)">StateItem</a></span>
structured array format.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#subscribe_to_notifications-instance_method" title="#subscribe_to_notifications (instance method)">#<strong>subscribe_to_notifications</strong>(type: :all, zone: :all, location: :all, predicate: nil, actor: :all, tracker: nil, &amp;block)  &#x21d2; void </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>This method &#39;subscribes&#39; a block to various types of notifications.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#unregister_state_item-instance_method" title="#unregister_state_item (instance method)">#<strong>unregister_state_item</strong>(item)  &#x21d2; void </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>This method unregisters a StateItem from the engine.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#unsubscribe_from_notifications-instance_method" title="#unsubscribe_from_notifications (instance method)">#<strong>unsubscribe_from_notifications</strong>(tracker)  &#x21d2; void </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>When you subscribe to a notification with <span class='object_link'><a href="#subscribe_to_notifications-instance_method" title="Demiurge::Engine#subscribe_to_notifications (method)">#subscribe_to_notifications</a></span>,
you may optionally pass a non-nil tracker with the subscription.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#valid_item_name%3F-instance_method" title="#valid_item_name? (instance method)">#<strong>valid_item_name?</strong>(name)  &#x21d2; Boolean </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Determine whether the item name is basically allowable.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#zones-instance_method" title="#zones (instance method)">#<strong>zones</strong>  &#x21d2; Array&lt;Demiurge::StateItem&gt; </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Get an Array of StateItems that are top-level <span class='object_link'><a href="Zone.html" title="Demiurge::Zone (class)">Zone</a></span> items.</p>
</div></span>
  
</li>

      
    </ul>
  


  
  
  
  
  
  
  
  
  <h3 class="inherited">Methods included from <span class='object_link'><a href="Util.html" title="Demiurge::Util (module)">Util</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="Util.html#copyfreeze-instance_method" title="Demiurge::Util#copyfreeze (method)">#copyfreeze</a></span>, <span class='object_link'><a href="Util.html#deepcopy-instance_method" title="Demiurge::Util#deepcopy (method)">#deepcopy</a></span></p>
<div id="constructor_details" class="method_details_list">
  <h2>Constructor Details</h2>
  
    <div class="method_details first">
  <h3 class="signature first" id="initialize-instance_method">
  
    #<strong>initialize</strong>(types: {}, state: [])  &#x21d2; <tt>void</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>This is the constructor for a new Engine object. Most frequently this will
be called by <span class='object_link'><a href="DSL.html" title="Demiurge::DSL (module)">DSL</a></span> or another external source which will also
supply item types and initial state.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>types</span>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>A name/value hash of item types supported by this engine&#39;s
serialization.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>state</span>
      
      
        <span class='type'>(<tt>Array</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>An array of serialized Demiurge items in <span class='object_link'><a href="StateItem.html" title="Demiurge::StateItem (class)">StateItem</a></span> structured
array format.</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>0.0.1</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/demiurge.rb', line 58</span>

<span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='label'>types:</span> <span class='lbrace'>{</span><span class='rbrace'>}</span><span class='comma'>,</span> <span class='label'>state:</span> <span class='lbracket'>[</span><span class='rbracket'>]</span><span class='rparen'>)</span>
  <span class='ivar'>@klasses</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_types'>types</span>
    <span class='id identifier rubyid_types'>types</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_tname'>tname</span><span class='comma'>,</span> <span class='id identifier rubyid_tval'>tval</span><span class='op'>|</span>
      <span class='id identifier rubyid_register_type'>register_type</span><span class='lparen'>(</span><span class='id identifier rubyid_tname'>tname</span><span class='comma'>,</span> <span class='id identifier rubyid_tval'>tval</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='ivar'>@finished_init</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='ivar'>@state_items</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span>
  <span class='ivar'>@zones</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_state_from_structured_array'>state_from_structured_array</span><span class='lparen'>(</span><span class='id identifier rubyid_state'>state</span> <span class='op'>||</span> <span class='lbracket'>[</span><span class='rbracket'>]</span><span class='rparen'>)</span>

  <span class='ivar'>@item_actions</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span>

  <span class='ivar'>@subscriptions_by_tracker</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span>

  <span class='ivar'>@queued_notifications</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
  <span class='ivar'>@queued_intentions</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>

  <span class='ivar'>@execution_context</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>

  <span class='kw'>nil</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
  
</div>

  <div id="instance_attr_details" class="attr_details">
    <h2>Instance Attribute Details</h2>
    
      
      <span id=""></span>
      <div class="method_details first">
  <h3 class="signature first" id="execution_context-instance_method">
  
    #<strong>execution_context</strong>  &#x21d2; <tt>Hash{String=&gt;String}</tt>  <span class="extras">(readonly)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns The current execution context for notifications and logging.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Hash{String=&gt;String}</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The current execution context for notifications and logging.</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>0.3.0</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


48
49
50</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/demiurge.rb', line 48</span>

<span class='kw'>def</span> <span class='id identifier rubyid_execution_context'>execution_context</span>
  <span class='ivar'>@execution_context</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id=""></span>
      <div class="method_details ">
  <h3 class="signature " id="ticks-instance_method">
  
    #<strong>ticks</strong>  &#x21d2; <tt>Integer</tt>  <span class="extras">(readonly)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns The number of ticks that have occurred since the beginning of this
Engine&#39;s history.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The number of ticks that have occurred since the beginning of this
Engine&#39;s history.</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>0.0.1</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


44
45
46</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/demiurge.rb', line 44</span>

<span class='kw'>def</span> <span class='id identifier rubyid_ticks'>ticks</span>
  <span class='ivar'>@ticks</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>


  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="action_for_item-instance_method">
  
    #<strong>action_for_item</strong>(item_name, action_name)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note private">
  <strong>This method is part of a private API.</strong>
  You should avoid using this method if possible, as it may be removed or be changed in the future.
</p>

<p>Fetch an action for an ActionItem that&#39;s stored in the engine.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>0.0.1</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


324
325
326</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/demiurge.rb', line 324</span>

<span class='kw'>def</span> <span class='id identifier rubyid_action_for_item'>action_for_item</span><span class='lparen'>(</span><span class='id identifier rubyid_item_name'>item_name</span><span class='comma'>,</span> <span class='id identifier rubyid_action_name'>action_name</span><span class='rparen'>)</span>
  <span class='ivar'>@item_actions</span><span class='lbracket'>[</span><span class='id identifier rubyid_item_name'>item_name</span><span class='rbracket'>]</span> <span class='op'>?</span> <span class='ivar'>@item_actions</span><span class='lbracket'>[</span><span class='id identifier rubyid_item_name'>item_name</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='id identifier rubyid_action_name'>action_name</span><span class='rbracket'>]</span> <span class='op'>:</span> <span class='kw'>nil</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="actions_for_item-instance_method">
  
    #<strong>actions_for_item</strong>(item_name)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note private">
  <strong>This method is part of a private API.</strong>
  You should avoid using this method if possible, as it may be removed or be changed in the future.
</p>

<p>Fetch actions for an ActionItem that&#39;s stored in the engine.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>0.0.1</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


332
333
334</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/demiurge.rb', line 332</span>

<span class='kw'>def</span> <span class='id identifier rubyid_actions_for_item'>actions_for_item</span><span class='lparen'>(</span><span class='id identifier rubyid_item_name'>item_name</span><span class='rparen'>)</span>
  <span class='ivar'>@item_actions</span><span class='lbracket'>[</span><span class='id identifier rubyid_item_name'>item_name</span><span class='rbracket'>]</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="admin_warning-instance_method">
  
    #<strong>admin_warning</strong>(message, info = {})  &#x21d2; <tt>void</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note returns_void">This method returns an undefined value.</p>
<p>Send a warning that something unfortunate but not continuity-threatening
has occurred. The problem isn&#39;t bad enough to warrant raising an
exception, but it&#39;s bad enough that we should collect data about the
problem. The warning normally indicates a problem in user-supplied code,
current state, or the Demiurge gem itself. These warnings can be subscribed
to with the notification type <span class='object_link'><a href="Notifications.html#AdminWarning-constant" title="Demiurge::Notifications::AdminWarning (constant)">Notifications::AdminWarning</a></span>.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>message</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>A user-readable log message indicating the problem that occurred</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>info</span>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>{}</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>A hash of additional fields that indicate the nature of the problem being
reported</p>
</div>
      
    </li>
  
</ul>

  
    
    
    
    
    <p class="tag_title">Options Hash (<tt>info</tt>):</p>
    <ul class="option">
      
        <li>
          <span class="name">"name"</span>
          <span class="type">(<tt>String</tt>)</span>
          <span class="default">
            
          </span>
          
            &mdash; <div class='inline'>
<p>The name of the item causing the problem</p>
</div>
          
        </li>
      
        <li>
          <span class="name">"zone"</span>
          <span class="type">(<tt>String</tt>)</span>
          <span class="default">
            
          </span>
          
            &mdash; <div class='inline'>
<p>The name of the zone where the problem is located, if known</p>
</div>
          
        </li>
      
    </ul>
  

<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>0.0.1</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


210
211
212
213</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/demiurge.rb', line 210</span>

<span class='kw'>def</span> <span class='id identifier rubyid_admin_warning'>admin_warning</span><span class='lparen'>(</span><span class='id identifier rubyid_message'>message</span><span class='comma'>,</span> <span class='id identifier rubyid_info'>info</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_send_notification'>send_notification</span><span class='lparen'>(</span><span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>message</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_message'>message</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>info</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_info'>info</span><span class='rbrace'>}</span><span class='comma'>,</span>
                    <span class='label'>type:</span> <span class='op'>::</span><span class='const'><span class='object_link'><a href="../Demiurge.html" title="Demiurge (module)">Demiurge</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Notifications.html" title="Demiurge::Notifications (module)">Notifications</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Notifications.html#AdminWarning-constant" title="Demiurge::Notifications::AdminWarning (constant)">AdminWarning</a></span></span><span class='comma'>,</span> <span class='label'>zone:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>admin</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>location:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>actor:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>include_context:</span> <span class='kw'>true</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="advance_one_tick-instance_method">
  
    #<strong>advance_one_tick</strong>  &#x21d2; <tt>void</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note returns_void">This method returns an undefined value.</p>
<p>Perform all necessary operations and phases for one “tick” of virtual time
to pass in the Engine.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>0.0.1</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


257
258
259
260
261
262
263</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/demiurge.rb', line 257</span>

<span class='kw'>def</span> <span class='id identifier rubyid_advance_one_tick'>advance_one_tick</span><span class='lparen'>(</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_queue_item_intentions'>queue_item_intentions</span>
  <span class='id identifier rubyid_flush_intentions'>flush_intentions</span>
  <span class='id identifier rubyid_send_notification'>send_notification</span><span class='lparen'>(</span><span class='lbrace'>{</span><span class='rbrace'>}</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'><span class='object_link'><a href="../Demiurge.html" title="Demiurge (module)">Demiurge</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Notifications.html" title="Demiurge::Notifications (module)">Notifications</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Notifications.html#TickFinished-constant" title="Demiurge::Notifications::TickFinished (constant)">TickFinished</a></span></span><span class='comma'>,</span> <span class='label'>location:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>zone:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>actor:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_flush_notifications'>flush_notifications</span>
  <span class='kw'>nil</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="all_actions_for_all_items-instance_method">
  
    #<strong>all_actions_for_all_items</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note private">
  <strong>This method is part of a private API.</strong>
  You should avoid using this method if possible, as it may be removed or be changed in the future.
</p>

<p>Fetch all actions for all items in an internal format.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>0.0.1</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


340
341
342</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/demiurge.rb', line 340</span>

<span class='kw'>def</span> <span class='id identifier rubyid_all_actions_for_all_items'>all_actions_for_all_items</span>
  <span class='ivar'>@item_actions</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="all_item_names-instance_method">
  
    #<strong>all_item_names</strong>  &#x21d2; <tt>Array&lt;String&gt;</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Get an array of all registered names for all items.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Array&lt;String&gt;</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>All registered item names for this <span class='object_link'><a href="" title="Demiurge::Engine (class)">Demiurge::Engine</a></span></p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>0.0.1</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


143
144
145</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/demiurge.rb', line 143</span>

<span class='kw'>def</span> <span class='id identifier rubyid_all_item_names'>all_item_names</span>
  <span class='ivar'>@state_items</span><span class='period'>.</span><span class='id identifier rubyid_keys'>keys</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="finished_init-instance_method">
  
    #<strong>finished_init</strong>  &#x21d2; <tt>void</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note returns_void">This method returns an undefined value.</p>
<p>The “finished_init” callback on Demiurge items exists to allow items to
finalize their structure relative to other items. For instance, containers
can ensure that their list of contents is identical to the set of items
that list the container as their location. This cannot be done until the
container is certain that all items have been added to the engine. The
#finished_init engine method calls StateItem#finished_init on
any items that respond to that callback. Normally
<span class='object_link'><a href="#finished_init-instance_method" title="Demiurge::Engine#finished_init (method)">#finished_init</a></span> should be called when a new Engine is
created, but not when restoring one from a state dump. This method should
not be called multiple times, and the Engine will try not to allow multiple
calls.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>0.0.1</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


98
99
100
101
102</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/demiurge.rb', line 98</span>

<span class='kw'>def</span> <span class='id identifier rubyid_finished_init'>finished_init</span>
  <span class='id identifier rubyid_raise'>raise</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Duplicate finished_init call to engine!</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='ivar'>@finished_init</span>
  <span class='ivar'>@state_items</span><span class='period'>.</span><span class='id identifier rubyid_values'>values</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_obj'>obj</span><span class='op'>|</span> <span class='id identifier rubyid_obj'>obj</span><span class='period'>.</span><span class='id identifier rubyid_finished_init'>finished_init</span><span class='lparen'>(</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_obj'>obj</span><span class='period'>.</span><span class='id identifier rubyid_respond_to?'>respond_to?</span><span class='lparen'>(</span><span class='symbol'>:finished_init</span><span class='rparen'>)</span> <span class='rbrace'>}</span>
  <span class='ivar'>@finished_init</span> <span class='op'>=</span> <span class='kw'>true</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="flush_intentions-instance_method">
  
    #<strong>flush_intentions</strong>  &#x21d2; <tt>void</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note returns_void">This method returns an undefined value.</p>
<p>Send out all pending <span class='object_link'><a href="Intention.html" title="Demiurge::Intention (class)">Intention</a></span>s in the <span class='object_link'><a href="Intention.html" title="Demiurge::Intention (class)">Intention</a></span>
queue. This will ordinarily happen at least once per tick in any case.
Calling this method outside the Engine&#39;s Intention phase of a tick may
cause unexpected results.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>0.0.1</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/demiurge.rb', line 222</span>

<span class='kw'>def</span> <span class='id identifier rubyid_flush_intentions'>flush_intentions</span>
  <span class='id identifier rubyid_state_backup'>state_backup</span> <span class='op'>=</span> <span class='id identifier rubyid_structured_state'>structured_state</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>copy</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='kw'>true</span><span class='rparen'>)</span>

  <span class='id identifier rubyid_infinite_loop_detector'>infinite_loop_detector</span> <span class='op'>=</span> <span class='int'>0</span>
  <span class='kw'>until</span> <span class='ivar'>@queued_intentions</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
    <span class='id identifier rubyid_infinite_loop_detector'>infinite_loop_detector</span> <span class='op'>+=</span> <span class='int'>1</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_infinite_loop_detector'>infinite_loop_detector</span> <span class='op'>&gt;</span> <span class='int'>20</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='op'>::</span><span class='const'><span class='object_link'><a href="../Demiurge.html" title="Demiurge (module)">Demiurge</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Errors.html" title="Demiurge::Errors (module)">Errors</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Errors/TooManyIntentionLoopsError.html" title="Demiurge::Errors::TooManyIntentionLoopsError (class)">TooManyIntentionLoopsError</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="Errors/Exception.html#initialize-instance_method" title="Demiurge::Errors::Exception#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Over 20 batches of intentions were dispatched in the same call! Error and die!</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>final_batch</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='ivar'>@queued_intentions</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_i'>i</span><span class='op'>|</span> <span class='id identifier rubyid_i'>i</span><span class='period'>.</span><span class='id identifier rubyid_class'>class</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span> <span class='rbrace'>}</span><span class='rparen'>)</span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_intentions'>intentions</span> <span class='op'>=</span> <span class='ivar'>@queued_intentions</span>
    <span class='ivar'>@queued_intentions</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
    <span class='kw'>begin</span>
      <span class='id identifier rubyid_intentions'>intentions</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_a'>a</span><span class='op'>|</span>
        <span class='kw'>if</span> <span class='id identifier rubyid_a'>a</span><span class='period'>.</span><span class='id identifier rubyid_cancelled?'>cancelled?</span>
          <span class='id identifier rubyid_admin_warning'>admin_warning</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Trying to apply a cancelled intention of type </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_a'>a</span><span class='period'>.</span><span class='id identifier rubyid_class'>class</span><span class='embexpr_end'>}</span><span class='tstring_content'>!</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>inspect</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_a'>a</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span><span class='rparen'>)</span>
        <span class='kw'>else</span>
          <span class='id identifier rubyid_a'>a</span><span class='period'>.</span><span class='id identifier rubyid_try_apply'>try_apply</span>
        <span class='kw'>end</span>
      <span class='kw'>end</span>
    <span class='kw'>rescue</span> <span class='op'>::</span><span class='const'><span class='object_link'><a href="../Demiurge.html" title="Demiurge (module)">Demiurge</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Errors.html" title="Demiurge::Errors (module)">Errors</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Errors/RetryableError.html" title="Demiurge::Errors::RetryableError (class)">RetryableError</a></span></span>
      <span class='id identifier rubyid_admin_warning'>admin_warning</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Exception when updating! Throwing away speculative state!</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>exception</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='gvar'>$_</span><span class='period'>.</span><span class='id identifier rubyid_jsonable'>jsonable</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_load_state_from_dump'>load_state_from_dump</span><span class='lparen'>(</span><span class='id identifier rubyid_state_backup'>state_backup</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='ivar'>@state_items</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>admin</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_state'>state</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>ticks</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span> <span class='op'>+=</span> <span class='int'>1</span>
  <span class='kw'>nil</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="flush_notifications-instance_method">
  
    #<strong>flush_notifications</strong>  &#x21d2; <tt>void</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note returns_void">This method returns an undefined value.</p>
<p>Send out any pending notifications that have been queued. This will
normally happen at least once per tick in any case, but may happen more
often. If this occurs during the Engine&#39;s tick, certain ordering issues
may occur. Normally it&#39;s best to let the Engine call this method during
the tick, and to only call it manually when no tick is occurring.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>0.0.1</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


655
656
657
658
659
660
661
662
663
664
665
666
667
668
669
670
671
672
673
674
675
676
677
678
679
680
681
682</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/demiurge.rb', line 655</span>

<span class='kw'>def</span> <span class='id identifier rubyid_flush_notifications'>flush_notifications</span>
  <span class='id identifier rubyid_infinite_loop_detector'>infinite_loop_detector</span> <span class='op'>=</span> <span class='int'>0</span>
  <span class='comment'># Dispatch the queued notifications. Then, dispatch any
</span>  <span class='comment'># notifications that resulted from them.  Then, keep doing that
</span>  <span class='comment'># until the queue is empty.
</span>  <span class='kw'>until</span> <span class='ivar'>@queued_notifications</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
    <span class='id identifier rubyid_infinite_loop_detector'>infinite_loop_detector</span> <span class='op'>+=</span> <span class='int'>1</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_infinite_loop_detector'>infinite_loop_detector</span> <span class='op'>&gt;</span> <span class='int'>20</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='op'>::</span><span class='const'><span class='object_link'><a href="../Demiurge.html" title="Demiurge (module)">Demiurge</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Errors.html" title="Demiurge::Errors (module)">Errors</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Errors/TooManyNotificationLoopsError.html" title="Demiurge::Errors::TooManyNotificationLoopsError (class)">TooManyNotificationLoopsError</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="Errors/Exception.html#initialize-instance_method" title="Demiurge::Errors::Exception#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Over 20 batches of notifications were dispatched in the same call! Error and die!</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>last batch</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='ivar'>@queued_notifications</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_n'>n</span><span class='op'>|</span> <span class='id identifier rubyid_n'>n</span><span class='period'>.</span><span class='id identifier rubyid_class'>class</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span> <span class='rbrace'>}</span><span class='rparen'>)</span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_current_notifications'>current_notifications</span> <span class='op'>=</span> <span class='ivar'>@queued_notifications</span>
    <span class='ivar'>@queued_notifications</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_current_notifications'>current_notifications</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_cleaned_data'>cleaned_data</span><span class='op'>|</span>
      <span class='ivar'>@subscriptions_by_tracker</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_tracker'>tracker</span><span class='comma'>,</span> <span class='id identifier rubyid_sub_structures'>sub_structures</span><span class='op'>|</span>
        <span class='id identifier rubyid_sub_structures'>sub_structures</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_sub_structure'>sub_structure</span><span class='op'>|</span>
          <span class='kw'>next</span> <span class='kw'>unless</span> <span class='id identifier rubyid_sub_structure'>sub_structure</span><span class='lbracket'>[</span><span class='symbol'>:type</span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='symbol'>:all</span> <span class='op'>||</span> <span class='id identifier rubyid_sub_structure'>sub_structure</span><span class='lbracket'>[</span><span class='symbol'>:type</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span><span class='lparen'>(</span><span class='id identifier rubyid_cleaned_data'>cleaned_data</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>type</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='kw'>next</span> <span class='kw'>unless</span> <span class='id identifier rubyid_sub_structure'>sub_structure</span><span class='lbracket'>[</span><span class='symbol'>:zone</span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='symbol'>:all</span> <span class='op'>||</span> <span class='id identifier rubyid_sub_structure'>sub_structure</span><span class='lbracket'>[</span><span class='symbol'>:zone</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span><span class='lparen'>(</span><span class='id identifier rubyid_cleaned_data'>cleaned_data</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>zone</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='kw'>next</span> <span class='kw'>unless</span> <span class='id identifier rubyid_sub_structure'>sub_structure</span><span class='lbracket'>[</span><span class='symbol'>:location</span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='symbol'>:all</span> <span class='op'>||</span> <span class='id identifier rubyid_sub_structure'>sub_structure</span><span class='lbracket'>[</span><span class='symbol'>:location</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span><span class='lparen'>(</span><span class='id identifier rubyid_cleaned_data'>cleaned_data</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>location</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='kw'>next</span> <span class='kw'>unless</span> <span class='id identifier rubyid_sub_structure'>sub_structure</span><span class='lbracket'>[</span><span class='symbol'>:actor</span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='symbol'>:all</span> <span class='op'>||</span> <span class='id identifier rubyid_sub_structure'>sub_structure</span><span class='lbracket'>[</span><span class='symbol'>:actor</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span><span class='lparen'>(</span><span class='id identifier rubyid_cleaned_data'>cleaned_data</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>actor</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='kw'>next</span> <span class='kw'>unless</span> <span class='id identifier rubyid_sub_structure'>sub_structure</span><span class='lbracket'>[</span><span class='symbol'>:predicate</span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='kw'>nil</span> <span class='op'>||</span> <span class='id identifier rubyid_sub_structure'>sub_structure</span><span class='lbracket'>[</span><span class='symbol'>:predicate</span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='symbol'>:all</span> <span class='op'>||</span> <span class='id identifier rubyid_sub_structure'>sub_structure</span><span class='lbracket'>[</span><span class='symbol'>:predicate</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_call'>call</span><span class='lparen'>(</span><span class='id identifier rubyid_cleaned_data'>cleaned_data</span><span class='rparen'>)</span>

          <span class='id identifier rubyid_sub_structure'>sub_structure</span><span class='lbracket'>[</span><span class='symbol'>:block</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_call'>call</span><span class='lparen'>(</span><span class='id identifier rubyid_cleaned_data'>cleaned_data</span><span class='rparen'>)</span>
        <span class='kw'>end</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="get_intention_id-instance_method">
  
    #<strong>get_intention_id</strong>  &#x21d2; <tt>Integer</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note private">
  <strong>This method is part of a private API.</strong>
  You should avoid using this method if possible, as it may be removed or be changed in the future.
</p>

<p>Get an intention ID which is guaranteed to never be returned by this method
again. It&#39;s not important that it be consecutive or otherwise special,
just that it be unique.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The new intention ID</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>0.2.0</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


154
155
156
157</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/demiurge.rb', line 154</span>

<span class='kw'>def</span> <span class='id identifier rubyid_get_intention_id'>get_intention_id</span>
  <span class='ivar'>@state_items</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>admin</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_state'>state</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>intention_id</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span> <span class='op'>+=</span> <span class='int'>1</span>
  <span class='kw'>return</span> <span class='ivar'>@state_items</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>admin</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_state'>state</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>intention_id</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="get_type-instance_method">
  
    #<strong>get_type</strong>(t)  &#x21d2; <tt>Class</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Get a StateItem type that is registered with this Engine, using the
registered name for that type.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>t</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The registered type name for this class object</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Class</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>A StateItem Class object</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>0.0.1</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


270
271
272
273</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/demiurge.rb', line 270</span>

<span class='kw'>def</span> <span class='id identifier rubyid_get_type'>get_type</span><span class='lparen'>(</span><span class='id identifier rubyid_t'>t</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_raise'>raise</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Not a valid type: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_content'>!</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='ivar'>@klasses</span><span class='lbracket'>[</span><span class='id identifier rubyid_t'>t</span><span class='rbracket'>]</span>
  <span class='ivar'>@klasses</span><span class='lbracket'>[</span><span class='id identifier rubyid_t'>t</span><span class='rbracket'>]</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="instantiate_new_item-instance_method">
  
    #<strong>instantiate_new_item</strong>(name, parent, extra_state = {})  &#x21d2; <tt><span class='object_link'><a href="StateItem.html" title="Demiurge::StateItem (class)">Demiurge::StateItem</a></span></tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>This method creates a new StateItem based on an existing parent StateItem,
and will retain some level of linkage to that parent StateItem afterward as
well. This provides a simple form of action inheritance and data
inheritance.</p>

<p>The new child item will begin with a copy of the parent&#39;s state which
can then be overridden. There will not be a longer-term link to the
parent&#39;s state, and any later state changes in the parent or child will
not affect each other.</p>

<p>There <em>will</em> be a longer-term link to the parent&#39;s actions, and
any action not overridden in the child item will fall back to the
parent&#39;s action of the same name.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>name</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The new item name to register with the engine</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>parent</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="StateItem.html" title="Demiurge::StateItem (class)">Demiurge::StateItem</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The parent StateItem</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>extra_state</span>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>{}</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>Additional state data for the child</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="StateItem.html" title="Demiurge::StateItem (class)">Demiurge::StateItem</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The newly-created StateItem which has been registered with the engine</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>0.0.1</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/demiurge.rb', line 393</span>

<span class='kw'>def</span> <span class='id identifier rubyid_instantiate_new_item'>instantiate_new_item</span><span class='lparen'>(</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_parent'>parent</span><span class='comma'>,</span> <span class='id identifier rubyid_extra_state'>extra_state</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_parent'>parent</span> <span class='op'>=</span> <span class='id identifier rubyid_item_by_name'>item_by_name</span><span class='lparen'>(</span><span class='id identifier rubyid_parent'>parent</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='id identifier rubyid_parent'>parent</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'><span class='object_link'><a href="StateItem.html" title="Demiurge::StateItem (class)">StateItem</a></span></span><span class='rparen'>)</span>
  <span class='id identifier rubyid_ss'>ss</span> <span class='op'>=</span> <span class='id identifier rubyid_parent'>parent</span><span class='period'>.</span><span class='id identifier rubyid_get_structure'>get_structure</span>

  <span class='comment'># The new instantiated item is different from the parent because
</span>  <span class='comment'># it has its own name, and because it can get named actions from
</span>  <span class='comment'># the parent as well as itself. The latter is important because
</span>  <span class='comment'># we can&#39;t easily make new action procs without an associated
</span>  <span class='comment'># World File of some kind.
</span>  <span class='id identifier rubyid_ss'>ss</span><span class='lbracket'>[</span><span class='int'>1</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_name'>name</span>
  <span class='id identifier rubyid_ss'>ss</span><span class='lbracket'>[</span><span class='int'>2</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_deepcopy'>deepcopy</span><span class='lparen'>(</span><span class='id identifier rubyid_ss'>ss</span><span class='lbracket'>[</span><span class='int'>2</span><span class='rbracket'>]</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_ss'>ss</span><span class='lbracket'>[</span><span class='int'>2</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_merge!'>merge!</span><span class='lparen'>(</span><span class='id identifier rubyid_extra_state'>extra_state</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_ss'>ss</span><span class='lbracket'>[</span><span class='int'>2</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>parent</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_parent'>parent</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span>

  <span class='id identifier rubyid_child'>child</span> <span class='op'>=</span> <span class='id identifier rubyid_register_state_item'>register_state_item</span><span class='lparen'>(</span><span class='const'><span class='object_link'><a href="StateItem.html" title="Demiurge::StateItem (class)">StateItem</a></span></span><span class='period'>.</span><span class='id identifier rubyid_from_name_type'><span class='object_link'><a href="StateItem.html#from_name_type-class_method" title="Demiurge::StateItem.from_name_type (method)">from_name_type</a></span></span><span class='lparen'>(</span><span class='kw'>self</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_ss'>ss</span><span class='rparen'>)</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='ivar'>@finished_init</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_child'>child</span><span class='period'>.</span><span class='id identifier rubyid_respond_to?'>respond_to?</span><span class='lparen'>(</span><span class='symbol'>:finished_init</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_child'>child</span><span class='period'>.</span><span class='id identifier rubyid_finished_init'>finished_init</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_child'>child</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="item_by_name-instance_method">
  
    #<strong>item_by_name</strong>(name)  &#x21d2; <tt><span class='object_link'><a href="StateItem.html" title="Demiurge::StateItem (class)">StateItem</a></span></tt><sup>?</sup> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Get a StateItem by its registered unique name.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>name</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The name registered with the <span class='object_link'><a href="" title="Demiurge::Engine (class)">Demiurge::Engine</a></span> for this item</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="StateItem.html" title="Demiurge::StateItem (class)">StateItem</a></span></tt>, <tt>nil</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The StateItem corresponding to this name or nil</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>0.0.1</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


127
128
129</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/demiurge.rb', line 127</span>

<span class='kw'>def</span> <span class='id identifier rubyid_item_by_name'>item_by_name</span><span class='lparen'>(</span><span class='id identifier rubyid_name'>name</span><span class='rparen'>)</span>
  <span class='ivar'>@state_items</span><span class='lbracket'>[</span><span class='id identifier rubyid_name'>name</span><span class='rbracket'>]</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="load_state_from_dump-instance_method">
  
    #<strong>load_state_from_dump</strong>(arr)  &#x21d2; <tt>void</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note returns_void">This method returns an undefined value.</p>
<p>This loads the Engine&#39;s state from structured <span class='object_link'><a href="StateItem.html" title="Demiurge::StateItem (class)">StateItem</a></span>
state that has been serialized. This method handles reinitializing,
signaling and whatnot. Use this method to restore state from a JSON dump or
a hypothetical scenario that didn&#39;t work out.</p>

<p>Note that this does <em>not</em> update code from Ruby files or otherwise
handle any changes in the World Files. For that, use
<span class='object_link'><a href="#reload_from_dsl_files-instance_method" title="Demiurge::Engine#reload_from_dsl_files (method)">#reload_from_dsl_files</a></span> or <span class='object_link'><a href="#reload_from_dsl_text-instance_method" title="Demiurge::Engine#reload_from_dsl_text (method)">#reload_from_dsl_text</a></span>.</p>

<p>You can only reload state or World Files for a running engine, never both.
If you want to reload <em>both</em>, make a new engine and use it, or
reload the two in an order of your choice. Keep in mind that some World
File changes can rename state items.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>arr</span>
      
      
        <span class='type'>(<tt>Array</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p><span class='object_link'><a href="StateItem.html" title="Demiurge::StateItem (class)">StateItem</a></span> structured state in the form of Ruby objects</p>
</div>
      
    </li>
  
</ul>


  <p class="tag_title">See Also:</p>
  <ul class="see">
    
      <li><span class='object_link'><a href="DSL.html#engine_from_dsl_files-class_method" title="Demiurge::DSL.engine_from_dsl_files (method)">DSL.engine_from_dsl_files</a></span></li>
    
      <li><span class='object_link'><a href="DSL.html#engine_from_dsl_text-class_method" title="Demiurge::DSL.engine_from_dsl_text (method)">DSL.engine_from_dsl_text</a></span></li>
    
      <li><span class='object_link'><a href="#reload_from_dsl_files-instance_method" title="Demiurge::Engine#reload_from_dsl_files (method)">#reload_from_dsl_files</a></span></li>
    
      <li><span class='object_link'><a href="#reload_from_dsl_text-instance_method" title="Demiurge::Engine#reload_from_dsl_text (method)">#reload_from_dsl_text</a></span></li>
    
  </ul>
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>0.0.1</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


506
507
508
509
510
511
512</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/demiurge.rb', line 506</span>

<span class='kw'>def</span> <span class='id identifier rubyid_load_state_from_dump'>load_state_from_dump</span><span class='lparen'>(</span><span class='id identifier rubyid_arr'>arr</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_send_notification'>send_notification</span><span class='lparen'>(</span><span class='label'>type:</span> <span class='const'><span class='object_link'><a href="../Demiurge.html" title="Demiurge (module)">Demiurge</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Notifications.html" title="Demiurge::Notifications (module)">Notifications</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Notifications.html#LoadStateStart-constant" title="Demiurge::Notifications::LoadStateStart (constant)">LoadStateStart</a></span></span><span class='comma'>,</span> <span class='label'>actor:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>location:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>zone:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>admin</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>include_context:</span> <span class='kw'>true</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_state_from_structured_array'>state_from_structured_array</span><span class='lparen'>(</span><span class='id identifier rubyid_arr'>arr</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_finished_init'>finished_init</span>
  <span class='id identifier rubyid_send_notification'>send_notification</span><span class='lparen'>(</span><span class='label'>type:</span> <span class='const'><span class='object_link'><a href="../Demiurge.html" title="Demiurge (module)">Demiurge</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Notifications.html" title="Demiurge::Notifications (module)">Notifications</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Notifications.html#LoadStateEnd-constant" title="Demiurge::Notifications::LoadStateEnd (constant)">LoadStateEnd</a></span></span><span class='comma'>,</span> <span class='label'>actor:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>location:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>zone:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>admin</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>include_context:</span> <span class='kw'>true</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_flush_notifications'>flush_notifications</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="next_step_intentions-instance_method">
  
    #<strong>next_step_intentions</strong>  &#x21d2; <tt>void</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note returns_void">This method returns an undefined value.</p>
<p>Calculate the intentions for the next round of the Intention phase of a
tick. This is not necessarily the same as all Intentions for the next tick
- sometimes an executed <span class='object_link'><a href="Intention.html" title="Demiurge::Intention (class)">Intention</a></span> will queue more
<span class='object_link'><a href="Intention.html" title="Demiurge::Intention (class)">Intention</a></span>s to run during the same phase of the same tick.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>0.0.1</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


192
193
194</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/demiurge.rb', line 192</span>

<span class='kw'>def</span> <span class='id identifier rubyid_next_step_intentions'>next_step_intentions</span><span class='lparen'>(</span><span class='rparen'>)</span>
  <span class='ivar'>@zones</span><span class='period'>.</span><span class='id identifier rubyid_flat_map'>flat_map</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_item'>item</span><span class='op'>|</span> <span class='id identifier rubyid_item'>item</span><span class='period'>.</span><span class='id identifier rubyid_intentions_for_next_step'>intentions_for_next_step</span> <span class='op'>||</span> <span class='lbracket'>[</span><span class='rbracket'>]</span> <span class='rbrace'>}</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="push_context-instance_method">
  
    #<strong>push_context</strong>(context) { ... } &#x21d2; <tt>void</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note private">
  <strong>This method is part of a private API.</strong>
  You should avoid using this method if possible, as it may be removed or be changed in the future.
</p>
<p class="note returns_void">This method returns an undefined value.</p>
<p>Certain context can be important to notifications, errors, logging and
other admin-available information. For instance: the current zone-in-tick
(if any), a current item taking an action and so on. This context can be
attached to notifications, admin warnings, system logging and similar.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>context</span>
      
      
        <span class='type'>(<tt>Hash{String=&gt;String}</tt>)</span>
      
      
      
    </li>
  
</ul>

<p class="tag_title">Yields:</p>
<ul class="yield">
  
    <li>
      
      
        <span class='type'></span>
      
      
      
        
        <div class='inline'>
<p>Evaluate the following block with the given context set</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>0.3.0</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


367
368
369
370
371
372</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/demiurge.rb', line 367</span>

<span class='kw'>def</span> <span class='id identifier rubyid_push_context'>push_context</span><span class='lparen'>(</span><span class='id identifier rubyid_context'>context</span><span class='rparen'>)</span>
  <span class='ivar'>@execution_context</span><span class='period'>.</span><span class='id identifier rubyid_push'>push</span><span class='lparen'>(</span><span class='id identifier rubyid_context'>context</span><span class='rparen'>)</span>
  <span class='kw'>yield</span>
<span class='kw'>ensure</span>
  <span class='ivar'>@execution_context</span><span class='period'>.</span><span class='id identifier rubyid_pop'>pop</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="queue_intention-instance_method">
  
    #<strong>queue_intention</strong>(intention)  &#x21d2; <tt>void</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note returns_void">This method returns an undefined value.</p>
<p>Add an intention to the Engine&#39;s Intention queue. If this method is
called during the Intention phase of a tick, the intention should be
excecuted during this tick in standard order. If the method is called
outside the Intention phase of a tick, the Intention will normally be
executed during the soonest upcoming Intention phase. Queued intentions are
subject to approval, cancellation and other normal operations that
Intentions undergo before being executed.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>intention</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="Intention.html" title="Demiurge::Intention (class)">Demiurge::Intention</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The intention to be queued</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>0.0.1</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


171
172
173
174</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/demiurge.rb', line 171</span>

<span class='kw'>def</span> <span class='id identifier rubyid_queue_intention'>queue_intention</span><span class='lparen'>(</span><span class='id identifier rubyid_intention'>intention</span><span class='rparen'>)</span>
  <span class='ivar'>@queued_intentions</span><span class='period'>.</span><span class='id identifier rubyid_push'>push</span> <span class='id identifier rubyid_intention'>intention</span>
  <span class='kw'>nil</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="queue_item_intentions-instance_method">
  
    #<strong>queue_item_intentions</strong>  &#x21d2; <tt>void</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note returns_void">This method returns an undefined value.</p>
<p>Queue all Intentions for all registered items for the current tick.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>0.0.1</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


180
181
182</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/demiurge.rb', line 180</span>

<span class='kw'>def</span> <span class='id identifier rubyid_queue_item_intentions'>queue_item_intentions</span><span class='lparen'>(</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_next_step_intentions'>next_step_intentions</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_i'>i</span><span class='op'>|</span> <span class='id identifier rubyid_queue_intention'>queue_intention</span><span class='lparen'>(</span><span class='id identifier rubyid_i'>i</span><span class='rparen'>)</span> <span class='rbrace'>}</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="register_actions_by_item_and_action_name-instance_method">
  
    #<strong>register_actions_by_item_and_action_name</strong>(item_actions)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>StateItems are transient and can be created, recreated or destroyed without
warning. They need to be hooked up to the various Ruby code for their
actions. The code for actions isn&#39;t serialized. Instead, each action is
referred to by name, and the engine loads up all the item-name/action-name
combinations when it reads the Ruby World Files. This means an action can
be referred to by its name when serialized, but the actual code changes any
time the world files are reloaded.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>0.0.1</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/demiurge.rb', line 298</span>

<span class='kw'>def</span> <span class='id identifier rubyid_register_actions_by_item_and_action_name'>register_actions_by_item_and_action_name</span><span class='lparen'>(</span><span class='id identifier rubyid_item_actions'>item_actions</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_item_actions'>item_actions</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_item_name'>item_name</span><span class='comma'>,</span> <span class='id identifier rubyid_act_hash'>act_hash</span><span class='op'>|</span>
    <span class='kw'>if</span> <span class='ivar'>@item_actions</span><span class='lbracket'>[</span><span class='id identifier rubyid_item_name'>item_name</span><span class='rbracket'>]</span>
      <span class='id identifier rubyid_act_hash'>act_hash</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_action_name'>action_name</span><span class='comma'>,</span> <span class='id identifier rubyid_opts'>opts</span><span class='op'>|</span>
        <span class='id identifier rubyid_existing'>existing</span> <span class='op'>=</span> <span class='ivar'>@item_actions</span><span class='lbracket'>[</span><span class='id identifier rubyid_item_name'>item_name</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='id identifier rubyid_action_name'>action_name</span><span class='rbracket'>]</span>
        <span class='kw'>if</span> <span class='id identifier rubyid_existing'>existing</span>
          <span class='const'><span class='object_link'><a href="ActionItem.html" title="Demiurge::ActionItem (class)">ActionItem</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="ActionItem.html#ACTION_LEGAL_KEYS-constant" title="Demiurge::ActionItem::ACTION_LEGAL_KEYS (constant)">ACTION_LEGAL_KEYS</a></span></span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_key'>key</span><span class='op'>|</span>
            <span class='kw'>if</span> <span class='id identifier rubyid_existing'>existing</span><span class='lbracket'>[</span><span class='id identifier rubyid_key'>key</span><span class='rbracket'>]</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_opts'>opts</span><span class='lbracket'>[</span><span class='id identifier rubyid_key'>key</span><span class='rbracket'>]</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_existing'>existing</span><span class='lbracket'>[</span><span class='id identifier rubyid_key'>key</span><span class='rbracket'>]</span> <span class='op'>!=</span> <span class='id identifier rubyid_opts'>opts</span><span class='lbracket'>[</span><span class='id identifier rubyid_key'>key</span><span class='rbracket'>]</span>
              <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Can&#39;t register action </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_action_name'>action_name</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_content'> for item </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_item_name'>item_name</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_content'>, conflict for key </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_key'>key</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_content'>!</span><span class='tstring_end'>&quot;</span></span>
            <span class='kw'>end</span>
          <span class='kw'>end</span>
          <span class='id identifier rubyid_existing'>existing</span><span class='period'>.</span><span class='id identifier rubyid_merge!'>merge!</span><span class='lparen'>(</span><span class='id identifier rubyid_opts'>opts</span><span class='rparen'>)</span>
        <span class='kw'>else</span>
          <span class='ivar'>@item_actions</span><span class='lbracket'>[</span><span class='id identifier rubyid_item_name'>item_name</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='id identifier rubyid_action_name'>action_name</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_opts'>opts</span>
        <span class='kw'>end</span>
      <span class='kw'>end</span>
    <span class='kw'>else</span>
      <span class='ivar'>@item_actions</span><span class='lbracket'>[</span><span class='id identifier rubyid_item_name'>item_name</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_act_hash'>act_hash</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="register_state_item-instance_method">
  
    #<strong>register_state_item</strong>(item)  &#x21d2; <tt><span class='object_link'><a href="StateItem.html" title="Demiurge::StateItem (class)">Demiurge::StateItem</a></span></tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Register a new StateItem</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>item</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="StateItem.html" title="Demiurge::StateItem (class)">Demiurge::StateItem</a></span></tt>)</span>
      
      
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="StateItem.html" title="Demiurge::StateItem (class)">Demiurge::StateItem</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The same item</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>0.0.1</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


428
429
430
431
432
433
434
435
436
437
438
439
440
441</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/demiurge.rb', line 428</span>

<span class='kw'>def</span> <span class='id identifier rubyid_register_state_item'>register_state_item</span><span class='lparen'>(</span><span class='id identifier rubyid_item'>item</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_name'>name</span> <span class='op'>=</span> <span class='id identifier rubyid_item'>item</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span>
  <span class='kw'>if</span> <span class='ivar'>@state_items</span><span class='lbracket'>[</span><span class='id identifier rubyid_name'>name</span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Duplicate item name: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_name'>name</span><span class='embexpr_end'>}</span><span class='tstring_content'>! Failing!</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
  <span class='ivar'>@state_items</span><span class='lbracket'>[</span><span class='id identifier rubyid_name'>name</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_item'>item</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_item'>item</span><span class='period'>.</span><span class='id identifier rubyid_zone?'>zone?</span>
    <span class='ivar'>@zones</span><span class='period'>.</span><span class='id identifier rubyid_push'>push</span><span class='lparen'>(</span><span class='id identifier rubyid_item'>item</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
  <span class='kw'>if</span> <span class='ivar'>@finished_init</span>
    <span class='id identifier rubyid_send_notification'>send_notification</span><span class='lparen'>(</span><span class='label'>type:</span> <span class='op'>::</span><span class='const'><span class='object_link'><a href="../Demiurge.html" title="Demiurge (module)">Demiurge</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Notifications.html" title="Demiurge::Notifications (module)">Notifications</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Notifications.html#NewItem-constant" title="Demiurge::Notifications::NewItem (constant)">NewItem</a></span></span><span class='comma'>,</span> <span class='label'>zone:</span> <span class='id identifier rubyid_item'>item</span><span class='period'>.</span><span class='id identifier rubyid_zone_name'>zone_name</span><span class='comma'>,</span> <span class='label'>location:</span> <span class='id identifier rubyid_item'>item</span><span class='period'>.</span><span class='id identifier rubyid_location_name'>location_name</span><span class='comma'>,</span> <span class='label'>actor:</span> <span class='id identifier rubyid_name'>name</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_item'>item</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="register_type-instance_method">
  
    #<strong>register_type</strong>(name, klass)  &#x21d2; <tt>void</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note returns_void">This method returns an undefined value.</p>
<p>Register a new StateItem type with a name that will be used in structured
<span class='object_link'><a href="StateItem.html" title="Demiurge::StateItem (class)">StateItem</a></span> dumps.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>name</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The name to use when registering this type</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>klass</span>
      
      
        <span class='type'>(<tt>Class</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The StateItem class to register with this name</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>0.0.1</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


281
282
283
284
285
286
287</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/demiurge.rb', line 281</span>

<span class='kw'>def</span> <span class='id identifier rubyid_register_type'>register_type</span><span class='lparen'>(</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_klass'>klass</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='ivar'>@klasses</span><span class='lbracket'>[</span><span class='id identifier rubyid_name'>name</span><span class='rbracket'>]</span> <span class='op'>&amp;&amp;</span> <span class='ivar'>@klasses</span><span class='lbracket'>[</span><span class='id identifier rubyid_name'>name</span><span class='rbracket'>]</span> <span class='op'>!=</span> <span class='id identifier rubyid_klass'>klass</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Re-registering name with different type! Name: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_name'>name</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_content'> Class: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_klass'>klass</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_content'> OldClass: </span><span class='embexpr_beg'>#{</span><span class='ivar'>@klasses</span><span class='lbracket'>[</span><span class='id identifier rubyid_name'>name</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_content'>!</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
  <span class='ivar'>@klasses</span><span class='lbracket'>[</span><span class='id identifier rubyid_name'>name</span><span class='rbracket'>]</span> <span class='op'>||=</span> <span class='id identifier rubyid_klass'>klass</span>
  <span class='kw'>nil</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="reload_from_dsl_files-instance_method">
  
    #<strong>reload_from_dsl_files</strong>(*filenames, options: {})  &#x21d2; <tt>void</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note returns_void">This method returns an undefined value.</p>
<p>This method loads new World File code into an existing engine. It should be
passed a list of filenames, normally roughly the same list that was passed
to Demiurge::DSL.engine_from_dsl_files to create the engine initially.</p>

<p>See <span class='object_link'><a href="#reload_from_dsl_text-instance_method" title="Demiurge::Engine#reload_from_dsl_text (method)">#reload_from_dsl_text</a></span> for more details and allowed options. It is
identical in operation except for taking code as parameters instead of
filenames.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>filenames</span>
      
      
        <span class='type'>(<tt>Array&lt;String&gt;</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>An array of filenames, suitable for calling File.read on</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>options</span>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>An optional hash of options for modifying the behavior of the reload</p>
</div>
      
    </li>
  
</ul>

  
    
    
    
    
    <p class="tag_title">Options Hash (<tt>options:</tt>):</p>
    <ul class="option">
      
        <li>
          <span class="name">verify_only</span>
          <span class="type">(<tt>Boolean</tt>)</span>
          <span class="default">
            
          </span>
          
            &mdash; <div class='inline'>
<p>Only see if the new engine code would load, don&#39;t replace any code.</p>
</div>
          
        </li>
      
        <li>
          <span class="name">guessing_okay</span>
          <span class="type">(<tt>Boolean</tt>)</span>
          <span class="default">
            
          </span>
          
            &mdash; <div class='inline'>
<p>Attempt to guess about renamed objects</p>
</div>
          
        </li>
      
        <li>
          <span class="name">no_addition</span>
          <span class="type">(<tt>Boolean</tt>)</span>
          <span class="default">
            
          </span>
          
            &mdash; <div class='inline'>
<p>Don&#39;t allow adding new StateItems, raise an error instead</p>
</div>
          
        </li>
      
        <li>
          <span class="name">no_addition</span>
          <span class="type">(<tt>Boolean</tt>)</span>
          <span class="default">
            
          </span>
          
            &mdash; <div class='inline'>
<p>Don&#39;t allow removing StateItems, raise an error instead</p>
</div>
          
        </li>
      
    </ul>
  


  <p class="tag_title">See Also:</p>
  <ul class="see">
    
      <li><a href="../file.RELOADING.html" title="RELOADING">RELOADING</a></li>
    
      <li><span class='object_link'><a href="DSL.html#engine_from_dsl_files-class_method" title="Demiurge::DSL.engine_from_dsl_files (method)">DSL.engine_from_dsl_files</a></span></li>
    
      <li><span class='object_link'><a href="#reload_from_dsl_text-instance_method" title="Demiurge::Engine#reload_from_dsl_text (method)">#reload_from_dsl_text</a></span></li>
    
      <li><span class='object_link'><a href="#load_state_from_dump-instance_method" title="Demiurge::Engine#load_state_from_dump (method)">#load_state_from_dump</a></span></li>
    
  </ul>
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>0.0.1</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


23
24
25
26</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/demiurge/dsl.rb', line 23</span>

<span class='kw'>def</span> <span class='id identifier rubyid_reload_from_dsl_files'>reload_from_dsl_files</span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_filenames'>filenames</span><span class='comma'>,</span> <span class='label'>options:</span> <span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_filename_string_pairs'>filename_string_pairs</span> <span class='op'>=</span> <span class='id identifier rubyid_filenames'>filenames</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_fn'>fn</span><span class='op'>|</span> <span class='lbracket'>[</span><span class='id identifier rubyid_fn'>fn</span><span class='comma'>,</span> <span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_read'>read</span><span class='lparen'>(</span><span class='id identifier rubyid_fn'>fn</span><span class='rparen'>)</span><span class='rbracket'>]</span> <span class='rbrace'>}</span>
  <span class='id identifier rubyid_engine_from_dsl_text'>engine_from_dsl_text</span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_filename_string_pairs'>filename_string_pairs</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="reload_from_dsl_text-instance_method">
  
    #<strong>reload_from_dsl_text</strong>(*specs, options: { &quot;verify_only&quot; =&gt; false, &quot;guessing_okay&quot; =&gt; false, &quot;no_addition&quot; =&gt; false, &quot;no_removal&quot; =&gt; false })  &#x21d2; <tt>void</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note returns_void">This method returns an undefined value.</p>
<p>This method loads new World File code into an existing engine. It should be
passed a list of “specs”, normally roughly the same list that was passed to
Demiurge::DSL.engine_from_dsl_files to create the engine initially. A
“spec” is either a single string of World File DSL code, or a two-element
array of the form: [“label”, “code”]. Each is a string. “Code” is World
File DSL Ruby code, while “label” is the name that will be used in stack
traces.</p>

<p>Options:</p>
<ul><li>
<p>verify_only - only check for errors, don&#39;t load the new code into the
engine, aka “dry run mode”</p>
</li><li>
<p>guessing_okay - attempt to notice renames and modify old state to new state
accordingly</p>
</li><li>
<p>no_addition - if any new StateItem would be created, raise a
NonMatchingStateError</p>
</li><li>
<p>no_removal - if any StateItem would be removed, raise a
NonMatchingStateError</p>
</li></ul>

<p>Note that if “guessing_okay” is turned on, certain cases where same-type or
(in the future) similar-type items are added and removed may be “guessed”
as renames rather than treated as addition or removal.</p>

<p>Where the files and world objects are essentially the same, this should
reload any code changes into the engine. Where they are different, the
method will try to determine the best match between the new and old state,
but may fail at doing so.</p>

<p>Ordinarily, this method should be called on a fully-configured,
fully-initialized engine with its full state loaded, in between ticks.</p>

<p>When in doubt, it&#39;s better to save state and reload the engine from
nothing. This gives far better opportunities for a human to determine what
changes have occurred and manually fix any errors. A game&#39;s current
state is a complex thing and a computer simply cannot correctly determine
all possible changes to it in a useful way.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>specs</span>
      
      
        <span class='type'>(<tt>Array&lt;String&gt;</tt>, <tt>Array&lt;Array&lt;String&gt;&gt;</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>An array of specs, see above</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>options</span>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>An optional hash of options for modifying the behavior of the reload</p>
</div>
      
    </li>
  
</ul>

  
    
    
    
    
    <p class="tag_title">Options Hash (<tt>options:</tt>):</p>
    <ul class="option">
      
        <li>
          <span class="name">verify_only</span>
          <span class="type">(<tt>Boolean</tt>)</span>
          <span class="default">
            
          </span>
          
            &mdash; <div class='inline'>
<p>Only see if the new engine code would load, don&#39;t replace any code.</p>
</div>
          
        </li>
      
        <li>
          <span class="name">guessing_okay</span>
          <span class="type">(<tt>Boolean</tt>)</span>
          <span class="default">
            
          </span>
          
            &mdash; <div class='inline'>
<p>Attempt to guess about renamed objects</p>
</div>
          
        </li>
      
        <li>
          <span class="name">no_addition</span>
          <span class="type">(<tt>Boolean</tt>)</span>
          <span class="default">
            
          </span>
          
            &mdash; <div class='inline'>
<p>Don&#39;t allow adding new StateItems, raise an error instead</p>
</div>
          
        </li>
      
        <li>
          <span class="name">no_addition</span>
          <span class="type">(<tt>Boolean</tt>)</span>
          <span class="default">
            
          </span>
          
            &mdash; <div class='inline'>
<p>Don&#39;t allow removing StateItems, raise an error instead</p>
</div>
          
        </li>
      
    </ul>
  


  <p class="tag_title">See Also:</p>
  <ul class="see">
    
      <li><a href="../file.RELOADING.html" title="RELOADING">RELOADING</a></li>
    
      <li><span class='object_link'><a href="DSL.html#engine_from_dsl_files-class_method" title="Demiurge::DSL.engine_from_dsl_files (method)">DSL.engine_from_dsl_files</a></span></li>
    
      <li><span class='object_link'><a href="DSL.html#engine_from_dsl_text-class_method" title="Demiurge::DSL.engine_from_dsl_text (method)">DSL.engine_from_dsl_text</a></span></li>
    
      <li><span class='object_link'><a href="#load_state_from_dump-instance_method" title="Demiurge::Engine#load_state_from_dump (method)">#load_state_from_dump</a></span></li>
    
  </ul>
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>0.0.1</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/demiurge/dsl.rb', line 77</span>

<span class='kw'>def</span> <span class='id identifier rubyid_reload_from_dsl_text'>reload_from_dsl_text</span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_specs'>specs</span><span class='comma'>,</span> <span class='label'>options:</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>verify_only</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='kw'>false</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>guessing_okay</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='kw'>false</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>no_addition</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='kw'>false</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>no_removal</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='kw'>false</span> <span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_old_engine'>old_engine</span> <span class='op'>=</span> <span class='kw'>self</span>
  <span class='id identifier rubyid_new_engine'>new_engine</span> <span class='op'>=</span> <span class='kw'>nil</span>

  <span class='id identifier rubyid_send_notification'>send_notification</span> <span class='label'>type:</span> <span class='const'><span class='object_link'><a href="../Demiurge.html" title="Demiurge (module)">Demiurge</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Notifications.html" title="Demiurge::Notifications (module)">Notifications</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Notifications.html#LoadWorldVerify-constant" title="Demiurge::Notifications::LoadWorldVerify (constant)">LoadWorldVerify</a></span></span><span class='comma'>,</span> <span class='label'>zone:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>admin</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>location:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>actor:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>include_context:</span> <span class='kw'>true</span>

  <span class='kw'>begin</span>
    <span class='id identifier rubyid_new_engine'>new_engine</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../Demiurge.html" title="Demiurge (module)">Demiurge</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="DSL.html" title="Demiurge::DSL (module)">DSL</a></span></span><span class='period'>.</span><span class='id identifier rubyid_engine_from_dsl_text'><span class='object_link'><a href="DSL.html#engine_from_dsl_text-class_method" title="Demiurge::DSL.engine_from_dsl_text (method)">engine_from_dsl_text</a></span></span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_specs'>specs</span><span class='rparen'>)</span>
  <span class='kw'>rescue</span>
    <span class='comment'># Didn&#39;t work? Leave the existing engine intact, but raise.
</span>    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><span class='object_link'><a href="../Demiurge.html" title="Demiurge (module)">Demiurge</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Errors.html" title="Demiurge::Errors (module)">Errors</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Errors/CannotLoadWorldFiles.html" title="Demiurge::Errors::CannotLoadWorldFiles (class)">CannotLoadWorldFiles</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="Errors/Exception.html#initialize-instance_method" title="Demiurge::Errors::Exception#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Error reloading World File text</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># Match up old and new state items, but the &quot;admin&quot; InertStateItem doesn&#39;t get messed with
</span>  <span class='id identifier rubyid_old_item_names'>old_item_names</span> <span class='op'>=</span> <span class='id identifier rubyid_old_engine'>old_engine</span><span class='period'>.</span><span class='id identifier rubyid_all_item_names'>all_item_names</span> <span class='op'>-</span> <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>admin</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_new_item_names'>new_item_names</span> <span class='op'>=</span> <span class='id identifier rubyid_new_engine'>new_engine</span><span class='period'>.</span><span class='id identifier rubyid_all_item_names'>all_item_names</span> <span class='op'>-</span> <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>admin</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>

  <span class='id identifier rubyid_shared_item_names'>shared_item_names</span> <span class='op'>=</span> <span class='id identifier rubyid_old_item_names'>old_item_names</span> <span class='op'>&amp;</span> <span class='id identifier rubyid_new_item_names'>new_item_names</span>
  <span class='id identifier rubyid_added_item_names'>added_item_names</span> <span class='op'>=</span> <span class='id identifier rubyid_new_item_names'>new_item_names</span> <span class='op'>-</span> <span class='id identifier rubyid_shared_item_names'>shared_item_names</span>
  <span class='id identifier rubyid_removed_item_names'>removed_item_names</span> <span class='op'>=</span> <span class='id identifier rubyid_old_item_names'>old_item_names</span> <span class='op'>-</span> <span class='id identifier rubyid_shared_item_names'>shared_item_names</span>
  <span class='id identifier rubyid_renamed_pairs'>renamed_pairs</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>guessing_okay</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>
    <span class='comment'># For right this second, don&#39;t guess. When guessing happens,
</span>    <span class='comment'># this will populate the renamed_pairs hash.
</span>  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>no_addition</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_added_item_names'>added_item_names</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>NonMatchingStateError</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>StateItems added when they weren&#39;t allowed: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_added_item_names'>added_item_names</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_content'>!</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>no_removal</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_removed_item_names'>removed_item_names</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>NonMatchingStateError</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>StateItems removed when they weren&#39;t allowed: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_removed_item_names'>removed_item_names</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_content'>!</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='comment'># Okay, finished with error checking - the dry-run is over
</span>  <span class='kw'>return</span> <span class='kw'>if</span> <span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>verify_only</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>

  <span class='comment'># Now, replace the engine code
</span>
  <span class='id identifier rubyid_send_notification'>send_notification</span> <span class='label'>type:</span> <span class='const'><span class='object_link'><a href="../Demiurge.html" title="Demiurge (module)">Demiurge</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Notifications.html" title="Demiurge::Notifications (module)">Notifications</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Notifications.html#LoadWorldStart-constant" title="Demiurge::Notifications::LoadWorldStart (constant)">LoadWorldStart</a></span></span><span class='comma'>,</span> <span class='label'>zone:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>admin</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>location:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>actor:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>include_context:</span> <span class='kw'>true</span>

  <span class='comment'># Replace all actions performed by ActionItems
</span>  <span class='id identifier rubyid_old_engine'>old_engine</span><span class='period'>.</span><span class='id identifier rubyid_replace_all_actions_for_all_items'>replace_all_actions_for_all_items</span><span class='lparen'>(</span><span class='id identifier rubyid_new_engine'>new_engine</span><span class='period'>.</span><span class='id identifier rubyid_all_actions_for_all_items'>all_actions_for_all_items</span><span class='rparen'>)</span>

  <span class='comment'># For removed items, delete the StateItem from the old engine
</span>  <span class='id identifier rubyid_removed_item_names'>removed_item_names</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_removed_item_name'>removed_item_name</span><span class='op'>|</span>
    <span class='id identifier rubyid_old_engine'>old_engine</span><span class='period'>.</span><span class='id identifier rubyid_unregister_state_item'>unregister_state_item</span><span class='lparen'>(</span><span class='id identifier rubyid_old_engine'>old_engine</span><span class='period'>.</span><span class='id identifier rubyid_item_by_name'>item_by_name</span> <span class='id identifier rubyid_removed_item_name'>removed_item_name</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># For added items, use the state data from the new engine and add the item to the old engine
</span>  <span class='id identifier rubyid_added_item_names'>added_item_names</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_added_item_name'>added_item_name</span><span class='op'>|</span>
    <span class='id identifier rubyid_new_item'>new_item</span> <span class='op'>=</span> <span class='id identifier rubyid_new_engine'>new_engine</span><span class='period'>.</span><span class='id identifier rubyid_item_by_name'>item_by_name</span><span class='lparen'>(</span><span class='id identifier rubyid_added_item_name'>added_item_name</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_ss'>ss</span> <span class='op'>=</span> <span class='id identifier rubyid_new_item'>new_item</span><span class='period'>.</span><span class='id identifier rubyid_structured_state'>structured_state</span>
    <span class='id identifier rubyid_old_engine'>old_engine</span><span class='period'>.</span><span class='id identifier rubyid_register_state_item'>register_state_item</span><span class='lparen'>(</span><span class='const'><span class='object_link'><a href="StateItem.html" title="Demiurge::StateItem (class)">StateItem</a></span></span><span class='period'>.</span><span class='id identifier rubyid_from_name_type'><span class='object_link'><a href="StateItem.html#from_name_type-class_method" title="Demiurge::StateItem.from_name_type (method)">from_name_type</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_old_engine'>old_engine</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_ss'>ss</span><span class='rparen'>)</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># A rename is basically an add and a remove... But not necessarily
</span>  <span class='comment'># with the same name. And the newly-created item uses the state
</span>  <span class='comment'># from the older item. A rename is also permitted to choose a new
</span>  <span class='comment'># type, so create the new item in the old engine with the new name
</span>  <span class='comment'># and type, but the old state.
</span>  <span class='id identifier rubyid_renamed_pairs'>renamed_pairs</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_old_name'>old_name</span><span class='comma'>,</span> <span class='id identifier rubyid_new_name'>new_name</span><span class='op'>|</span>
    <span class='id identifier rubyid_old_item'>old_item</span> <span class='op'>=</span> <span class='id identifier rubyid_old_engine'>old_engine</span><span class='period'>.</span><span class='id identifier rubyid_item_by_name'>item_by_name</span><span class='lparen'>(</span><span class='id identifier rubyid_old_name'>old_name</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_new_item'>new_item</span> <span class='op'>=</span> <span class='id identifier rubyid_new_engine'>new_engine</span><span class='period'>.</span><span class='id identifier rubyid_item_by_name'>item_by_name</span><span class='lparen'>(</span><span class='id identifier rubyid_new_name'>new_name</span><span class='rparen'>)</span>

    <span class='id identifier rubyid_old_type'>old_type</span><span class='comma'>,</span> <span class='id identifier rubyid__'>_</span><span class='comma'>,</span> <span class='id identifier rubyid_old_state'>old_state</span> <span class='op'>=</span> <span class='op'>*</span><span class='id identifier rubyid_old_item'>old_item</span><span class='period'>.</span><span class='id identifier rubyid_structured_state'>structured_state</span>
    <span class='id identifier rubyid_new_type'>new_type</span><span class='comma'>,</span> <span class='id identifier rubyid__'>_</span><span class='comma'>,</span> <span class='id identifier rubyid_new_state'>new_state</span> <span class='op'>=</span> <span class='op'>*</span><span class='id identifier rubyid_new_item'>new_item</span><span class='period'>.</span><span class='id identifier rubyid_structured_state'>structured_state</span>

    <span class='id identifier rubyid_old_engine'>old_engine</span><span class='period'>.</span><span class='id identifier rubyid_unregister_state_item'>unregister_state_item</span><span class='lparen'>(</span><span class='id identifier rubyid_old_item'>old_item</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_old_engine'>old_engine</span><span class='period'>.</span><span class='id identifier rubyid_register_state_item'>register_state_item</span><span class='lparen'>(</span><span class='const'><span class='object_link'><a href="StateItem.html" title="Demiurge::StateItem (class)">StateItem</a></span></span><span class='period'>.</span><span class='id identifier rubyid_from_name_type'><span class='object_link'><a href="StateItem.html#from_name_type-class_method" title="Demiurge::StateItem.from_name_type (method)">from_name_type</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_old_engine'>old_engine</span><span class='comma'>,</span> <span class='id identifier rubyid_new_type'>new_type</span><span class='comma'>,</span> <span class='id identifier rubyid_new_name'>new_name</span><span class='comma'>,</span> <span class='id identifier rubyid_old_state'>old_state</span><span class='rparen'>)</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_send_notification'>send_notification</span> <span class='label'>type:</span> <span class='const'><span class='object_link'><a href="../Demiurge.html" title="Demiurge (module)">Demiurge</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Notifications.html" title="Demiurge::Notifications (module)">Notifications</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Notifications.html#LoadWorldEnd-constant" title="Demiurge::Notifications::LoadWorldEnd (constant)">LoadWorldEnd</a></span></span><span class='comma'>,</span> <span class='label'>zone:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>admin</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>location:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>actor:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>include_context:</span> <span class='kw'>true</span>
  <span class='kw'>nil</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="replace_all_actions_for_all_items-instance_method">
  
    #<strong>replace_all_actions_for_all_items</strong>(item_action_hash)  &#x21d2; <tt>void</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note private">
  <strong>This method is part of a private API.</strong>
  You should avoid using this method if possible, as it may be removed or be changed in the future.
</p>
<p class="note returns_void">This method returns an undefined value.</p>
<p>Replace actions for an item with other, potentially quite different,
actions. This is normally done to reload engine state from World Files.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>0.0.1</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


351
352
353
354</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/demiurge.rb', line 351</span>

<span class='kw'>def</span> <span class='id identifier rubyid_replace_all_actions_for_all_items'>replace_all_actions_for_all_items</span><span class='lparen'>(</span><span class='id identifier rubyid_item_action_hash'>item_action_hash</span><span class='rparen'>)</span>
  <span class='ivar'>@item_actions</span> <span class='op'>=</span> <span class='id identifier rubyid_item_action_hash'>item_action_hash</span>
  <span class='kw'>nil</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="send_notification-instance_method">
  
    #<strong>send_notification</strong>(data = {}, type:, zone:, location:, actor:, include_context: false)  &#x21d2; <tt>void</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note returns_void">This method returns an undefined value.</p>
<p>Queue a notification to be sent later by the engine. The notification must
include at least type, zone, location and actor and may include a hash of
additional data, which should be serializable to JSON (i.e. use only basic
data types.)</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>type</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The notification type of this notification</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>zone</span>
      
      
        <span class='type'>(<tt>String</tt>, <tt>nil</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The zone name for this notification. The special “admin” zone name is used
for engine-wide events</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>location</span>
      
      
        <span class='type'>(<tt>String</tt>, <tt>nil</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The location name for this notification, or nil if no location</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>actor</span>
      
      
        <span class='type'>(<tt>String</tt>, <tt>nil</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The name of the acting item for this notification, or nil if no item is
acting</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>data</span>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>{}</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>Additional data about this notification; please use String keys for the
Hash</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>0.0.1</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


626
627
628
629
630
631
632
633
634
635
636
637
638
639
640
641
642
643
644</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/demiurge.rb', line 626</span>

<span class='kw'>def</span> <span class='id identifier rubyid_send_notification'>send_notification</span><span class='lparen'>(</span><span class='id identifier rubyid_data'>data</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span><span class='comma'>,</span> <span class='label'>type:</span><span class='comma'>,</span> <span class='label'>zone:</span><span class='comma'>,</span> <span class='label'>location:</span><span class='comma'>,</span> <span class='label'>actor:</span><span class='comma'>,</span> <span class='label'>include_context:</span><span class='kw'>false</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Notification type must be a String, not </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_type'>type</span><span class='period'>.</span><span class='id identifier rubyid_class'>class</span><span class='embexpr_end'>}</span><span class='tstring_content'>!</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>unless</span> <span class='id identifier rubyid_type'>type</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>String</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Location must be a String, not </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_location'>location</span><span class='period'>.</span><span class='id identifier rubyid_class'>class</span><span class='embexpr_end'>}</span><span class='tstring_content'>!</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>unless</span> <span class='id identifier rubyid_location'>location</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>String</span><span class='rparen'>)</span> <span class='op'>||</span> <span class='id identifier rubyid_location'>location</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Zone must be a String, not </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_zone'>zone</span><span class='period'>.</span><span class='id identifier rubyid_class'>class</span><span class='embexpr_end'>}</span><span class='tstring_content'>!</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>unless</span> <span class='id identifier rubyid_zone'>zone</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>String</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Acting item must be a String or nil, not </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_actor'>actor</span><span class='period'>.</span><span class='id identifier rubyid_class'>class</span><span class='embexpr_end'>}</span><span class='tstring_content'>!</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>unless</span> <span class='id identifier rubyid_actor'>actor</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>String</span><span class='rparen'>)</span> <span class='op'>||</span> <span class='id identifier rubyid_actor'>actor</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>

  <span class='ivar'>@state_items</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>admin</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_state'>state</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>notification_id</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span> <span class='op'>+=</span> <span class='int'>1</span>

  <span class='id identifier rubyid_cleaned_data'>cleaned_data</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span>
  <span class='id identifier rubyid_cleaned_data'>cleaned_data</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>context</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='ivar'>@execution_context</span> <span class='kw'>if</span> <span class='id identifier rubyid_include_context'>include_context</span>
  <span class='id identifier rubyid_data'>data</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_key'>key</span><span class='comma'>,</span> <span class='id identifier rubyid_val'>val</span><span class='op'>|</span>
    <span class='comment'># TODO: verify somehow that this is JSON-serializable?
</span>    <span class='id identifier rubyid_cleaned_data'>cleaned_data</span><span class='lbracket'>[</span><span class='id identifier rubyid_key'>key</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_val'>val</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_cleaned_data'>cleaned_data</span><span class='period'>.</span><span class='id identifier rubyid_merge!'>merge!</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>type</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_type'>type</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>zone</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_zone'>zone</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>location</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_location'>location</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>actor</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_actor'>actor</span><span class='comma'>,</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>notification_id</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='ivar'>@state_items</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>admin</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_state'>state</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>notification_id</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>

  <span class='ivar'>@queued_notifications</span><span class='period'>.</span><span class='id identifier rubyid_push'>push</span><span class='lparen'>(</span><span class='id identifier rubyid_cleaned_data'>cleaned_data</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="structured_state-instance_method">
  
    #<strong>structured_state</strong>(options = { &quot;copy&quot; =&gt; false })  &#x21d2; <tt>Array</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>This method dumps the Engine&#39;s state in <span class='object_link'><a href="StateItem.html" title="Demiurge::StateItem (class)">StateItem</a></span>
structured array format. This method is how one would normally collect a
full state dump of the engine suitable for later restoration.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>options</span>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>{ &quot;copy&quot; =&gt; false }</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>Options for dumping state</p>
</div>
      
    </li>
  
</ul>

  
    
    
    <p class="tag_title">Options Hash (<tt>options</tt>):</p>
    <ul class="option">
      
        <li>
          <span class="name">copy</span>
          <span class="type">(<tt>Boolean</tt>)</span>
          <span class="default">
            
          </span>
          
            &mdash; <div class='inline'>
<p>If true, copy the serialized state rather than allowing any links into
StateItem objects. This reduces performance but increases security.</p>
</div>
          
        </li>
      
    </ul>
  

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Array</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The engine&#39;s state in <span class='object_link'><a href="StateItem.html" title="Demiurge::StateItem (class)">StateItem</a></span> structured array format</p>
</div>
      
    </li>
  
</ul>

  <p class="tag_title">See Also:</p>
  <ul class="see">
    
      <li><span class='object_link'><a href="#load_state_from_dump-instance_method" title="Demiurge::Engine#load_state_from_dump (method)">#load_state_from_dump</a></span></li>
    
  </ul>
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>0.0.1</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


114
115
116
117
118
119
120</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/demiurge.rb', line 114</span>

<span class='kw'>def</span> <span class='id identifier rubyid_structured_state'>structured_state</span><span class='lparen'>(</span><span class='id identifier rubyid_options'>options</span> <span class='op'>=</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>copy</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='kw'>false</span> <span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_dump'>dump</span> <span class='op'>=</span> <span class='ivar'>@state_items</span><span class='period'>.</span><span class='id identifier rubyid_values'>values</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_item'>item</span><span class='op'>|</span> <span class='id identifier rubyid_item'>item</span><span class='period'>.</span><span class='id identifier rubyid_get_structure'>get_structure</span> <span class='rbrace'>}</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>copy</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_dump'>dump</span> <span class='op'>=</span> <span class='id identifier rubyid_deepcopy'>deepcopy</span><span class='lparen'>(</span><span class='id identifier rubyid_dump'>dump</span><span class='rparen'>)</span>  <span class='comment'># Make sure it doesn&#39;t share state...
</span>  <span class='kw'>end</span>
  <span class='id identifier rubyid_dump'>dump</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="subscribe_to_notifications-instance_method">
  
    #<strong>subscribe_to_notifications</strong>(type: :all, zone: :all, location: :all, predicate: nil, actor: :all, tracker: nil, &amp;block)  &#x21d2; <tt>void</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note returns_void">This method returns an undefined value.</p>
<p>This method &#39;subscribes&#39; a block to various types of notifications.
The block will be called with the notifications when they occur. A
“specifier” for this method means either the special symbol
<code>:all</code> or an Array of Symbols or Strings to show what values a
notification may have for the given field. For fields that might indicate
Demiurge items such as “zone” or “actor” the value should be the Demiurge
item <em>name</em>, not the item itself.</p>

<p>When a notification occurs that matches the subscription, the given block
will be called with a hash of data about that notification.</p>

<p>The tracker is supplied to allow later unsubscribes. Pass a unique tracker
object (usually a String or Symbol) when subscribing, then pass in the same
one when unsubscribing.</p>

<p>At a minimum, subscriptions should include a zone to avoid subscribing to
all such notifications everywhere in the engine. Engine-wide subscriptions
become very inefficient very quickly.</p>

<p>Notifications only have a few mandatory fields - type, actor, zone and
location. The location and/or actor can be nil in some cases, and the zone
can be “admin” for engine-wide events. If you wish to subscribe based on
other properties of the notification then you&#39;ll need to pass a custom
predicate to check each notification. A “predicate” just means it&#39;s a
proc that returns true or false, depending whether a notification matches.</p>

<p>subscribe_to_notifications(zone: “my zone name”, location: “my location”) {
|h| puts “Got #Demiurge::Engine.hh.inspect!” }</p>

<p>subscribe_to_notifications(zone: “my zone”, type: “say”) { |h| puts
“Somebody said something!” }</p>

<p>subscribe_to_notifications(zone: [“one”, “two”, “three”], type: “move_to”,
actor: “bozo the clown”, tracker: “bozo move tracker”) { |h| bozo_move(h) }</p>

<p>subscribe_to_notifications(zone: “green field”, type: “joyous dance”,
predicate: proc { |h| <a href=""info"">h</a>[“subtype”] == “butterfly
wiggle” }) { |h| process(h) }</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <p class="tag_title">Examples:</p>
    
      
        <p class="example_title"><div class='inline'>
<p>Subscribe to all notification types at a particular location</p>
</div></p>
      
      <pre class="example code"><code></code></pre>
    
      
        <p class="example_title"><div class='inline'>
<p>Subscribe to all “say” notifications in my same zone</p>
</div></p>
      
      <pre class="example code"><code></code></pre>
    
      
        <p class="example_title"><div class='inline'>
<p>Subscribe to all move_to notifications for a specific actor, with a tracker
for future unsubscription</p>
</div></p>
      
      <pre class="example code"><code></code></pre>
    
      
        <p class="example_title"><div class='inline'>
<p>Subscribe to notifications matching a custom predicate</p>
</div></p>
      
      <pre class="example code"><code></code></pre>
    
  </div>
<p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>type</span>
      
      
        <span class='type'>(<tt>:all</tt>, <tt>String</tt>, <tt>Array&lt;Symbol&gt;</tt>, <tt>Array&lt;String&gt;</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>A specifier for what Demiurge notification names to subscribe to</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>zone</span>
      
      
        <span class='type'>(<tt>:all</tt>, <tt>String</tt>, <tt>Array&lt;Symbol&gt;</tt>, <tt>Array&lt;String&gt;</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>A specifier for what Zone names match this subscription</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>location</span>
      
      
        <span class='type'>(<tt>:all</tt>, <tt>String</tt>, <tt>Array&lt;Symbol&gt;</tt>, <tt>Array&lt;String&gt;</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>A specifier for what location names match this subscription</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>predicate</span>
      
      
        <span class='type'>(<tt>Proc</tt>, <tt>nil</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Call this proc on each notification to see if it matches this subscription</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>actor</span>
      
      
        <span class='type'>(<tt>:all</tt>, <tt>String</tt>, <tt>Array&lt;Symbol&gt;</tt>, <tt>Array&lt;String&gt;</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>A specifier for what Demiurge item name(s) must be the actor in a
notification to match this subscription</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>tracker</span>
      
      
        <span class='type'>(<tt>Object</tt>, <tt>nil</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>To unsubscribe from this notification later, pass in the same tracker to
<span class='object_link'><a href="#unsubscribe_from_notifications-instance_method" title="Demiurge::Engine#unsubscribe_from_notifications (method)">#unsubscribe_from_notifications</a></span>, or another object that is +==+ to this
tracker. A tracker is most often a String or Symbol. If the tracker is nil,
you can&#39;t ever unsubscribe.</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>0.0.1</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


582
583
584
585
586
587
588
589
590
591
592
593
594
595</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/demiurge.rb', line 582</span>

<span class='kw'>def</span> <span class='id identifier rubyid_subscribe_to_notifications'>subscribe_to_notifications</span><span class='lparen'>(</span><span class='label'>type:</span> <span class='symbol'>:all</span><span class='comma'>,</span> <span class='label'>zone:</span> <span class='symbol'>:all</span><span class='comma'>,</span> <span class='label'>location:</span> <span class='symbol'>:all</span><span class='comma'>,</span> <span class='label'>predicate:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>actor:</span> <span class='symbol'>:all</span><span class='comma'>,</span> <span class='label'>tracker:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_sub_structure'>sub_structure</span> <span class='op'>=</span> <span class='lbrace'>{</span>
    <span class='label'>type:</span> <span class='id identifier rubyid_notification_spec'>notification_spec</span><span class='lparen'>(</span><span class='id identifier rubyid_type'>type</span><span class='rparen'>)</span><span class='comma'>,</span>
    <span class='label'>zone:</span> <span class='id identifier rubyid_notification_spec'>notification_spec</span><span class='lparen'>(</span><span class='id identifier rubyid_zone'>zone</span><span class='rparen'>)</span><span class='comma'>,</span>
    <span class='label'>location:</span> <span class='id identifier rubyid_notification_spec'>notification_spec</span><span class='lparen'>(</span><span class='id identifier rubyid_location'>location</span><span class='rparen'>)</span><span class='comma'>,</span>
    <span class='label'>actor:</span> <span class='id identifier rubyid_notification_spec'>notification_spec</span><span class='lparen'>(</span><span class='id identifier rubyid_actor'>actor</span><span class='rparen'>)</span><span class='comma'>,</span>
    <span class='label'>predicate:</span> <span class='id identifier rubyid_predicate'>predicate</span><span class='comma'>,</span>
    <span class='label'>tracker:</span> <span class='id identifier rubyid_tracker'>tracker</span><span class='comma'>,</span>
    <span class='label'>block:</span> <span class='id identifier rubyid_block'>block</span><span class='comma'>,</span>
  <span class='rbrace'>}</span>
  <span class='ivar'>@subscriptions_by_tracker</span><span class='lbracket'>[</span><span class='id identifier rubyid_tracker'>tracker</span><span class='rbracket'>]</span> <span class='op'>||=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
  <span class='ivar'>@subscriptions_by_tracker</span><span class='lbracket'>[</span><span class='id identifier rubyid_tracker'>tracker</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_push'>push</span><span class='lparen'>(</span><span class='id identifier rubyid_sub_structure'>sub_structure</span><span class='rparen'>)</span>
  <span class='kw'>nil</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="unregister_state_item-instance_method">
  
    #<strong>unregister_state_item</strong>(item)  &#x21d2; <tt>void</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note returns_void">This method returns an undefined value.</p>
<p>This method unregisters a StateItem from the engine. The method assumes
other items don&#39;t refer to the item being unregistered.
<span class='object_link'><a href="#unregister_state_item-instance_method" title="Demiurge::Engine#unregister_state_item (method)">#unregister_state_item</a></span> will try to perform basic cleanup, but calling it
<em>can</em> leave dangling references.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>item</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="StateItem.html" title="Demiurge::StateItem (class)">Demiurge::StateItem</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The item to unregister</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>0.0.1</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


451
452
453
454
455
456
457
458
459</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/demiurge.rb', line 451</span>

<span class='kw'>def</span> <span class='id identifier rubyid_unregister_state_item'>unregister_state_item</span><span class='lparen'>(</span><span class='id identifier rubyid_item'>item</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_loc'>loc</span> <span class='op'>=</span> <span class='id identifier rubyid_item'>item</span><span class='period'>.</span><span class='id identifier rubyid_location'>location</span>
  <span class='id identifier rubyid_loc'>loc</span><span class='period'>.</span><span class='id identifier rubyid_ensure_does_not_contain'>ensure_does_not_contain</span><span class='lparen'>(</span><span class='id identifier rubyid_item'>item</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_zone'>zone</span> <span class='op'>=</span> <span class='id identifier rubyid_item'>item</span><span class='period'>.</span><span class='id identifier rubyid_zone'>zone</span>
  <span class='id identifier rubyid_zone'>zone</span><span class='period'>.</span><span class='id identifier rubyid_ensure_does_not_contain'>ensure_does_not_contain</span><span class='lparen'>(</span><span class='id identifier rubyid_item'>item</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span><span class='rparen'>)</span>
  <span class='ivar'>@state_items</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='id identifier rubyid_item'>item</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span><span class='rparen'>)</span>
  <span class='ivar'>@zones</span> <span class='op'>-=</span> <span class='lbracket'>[</span><span class='id identifier rubyid_item'>item</span><span class='rbracket'>]</span>
  <span class='kw'>nil</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="unsubscribe_from_notifications-instance_method">
  
    #<strong>unsubscribe_from_notifications</strong>(tracker)  &#x21d2; <tt>void</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note returns_void">This method returns an undefined value.</p>
<p>When you subscribe to a notification with <span class='object_link'><a href="#subscribe_to_notifications-instance_method" title="Demiurge::Engine#subscribe_to_notifications (method)">#subscribe_to_notifications</a></span>,
you may optionally pass a non-nil tracker with the subscription. If you
pass that tracker to this method, it will unsubscribe you from that
notification. Multiple subscriptions can use the same tracker and they will
all be unsubscribed at once. For that reason, you should use a unique
tracker if you do <em>not</em> want other code to be able to unsubscribe
you from notifications.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>tracker</span>
      
      
        <span class='type'>(<tt>Object</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The tracker from which to unsubscribe</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>0.0.1</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


609
610
611
612</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/demiurge.rb', line 609</span>

<span class='kw'>def</span> <span class='id identifier rubyid_unsubscribe_from_notifications'>unsubscribe_from_notifications</span><span class='lparen'>(</span><span class='id identifier rubyid_tracker'>tracker</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Tracker must be non-nil!</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_tracker'>tracker</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='ivar'>@subscriptions_by_tracker</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='id identifier rubyid_tracker'>tracker</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="valid_item_name?-instance_method">
  
    #<strong>valid_item_name?</strong>(name)  &#x21d2; <tt>Boolean</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Determine whether the item name is basically allowable.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>name</span>
      
      
        <span class='type'></span>
      
      
      
        &mdash;
        <div class='inline'>
<p>String The item name to check</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Whether the item name is valid, just in terms of its characters.</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>0.0.1</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


419
420
421</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/demiurge.rb', line 419</span>

<span class='kw'>def</span> <span class='id identifier rubyid_valid_item_name?'>valid_item_name?</span><span class='lparen'>(</span><span class='id identifier rubyid_name'>name</span><span class='rparen'>)</span>
  <span class='op'>!</span><span class='op'>!</span><span class='lparen'>(</span><span class='id identifier rubyid_name'>name</span> <span class='op'>=~</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>\A[-_ 0-9a-zA-Z]+\Z</span><span class='regexp_end'>/</span></span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="zones-instance_method">
  
    #<strong>zones</strong>  &#x21d2; <tt>Array&lt;<span class='object_link'><a href="StateItem.html" title="Demiurge::StateItem (class)">Demiurge::StateItem</a></span>&gt;</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Get an Array of StateItems that are top-level <span class='object_link'><a href="Zone.html" title="Demiurge::Zone (class)">Zone</a></span> items.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Array&lt;<span class='object_link'><a href="StateItem.html" title="Demiurge::StateItem (class)">Demiurge::StateItem</a></span>&gt;</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>All registered StateItems that are treated as <span class='object_link'><a href="Zone.html" title="Demiurge::Zone (class)">Zone</a></span> items</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>0.0.1</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


135
136
137</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/demiurge.rb', line 135</span>

<span class='kw'>def</span> <span class='id identifier rubyid_zones'>zones</span>
  <span class='ivar'>@zones</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

      <div id="footer">
  Generated on Tue Jan 16 12:25:07 2018 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.12 (ruby-2.3.1).
</div>

    </div>
  </body>
</html>